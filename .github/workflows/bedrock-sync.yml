name: Check Bedrock & Add-ons upstream & bump (minecraftserver)

on:
  schedule:
    - cron: "0,15,30,45 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-minecraftserver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools (jq, yq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -sSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # Stap 1: Lees oude versies uit build.yaml
      - name: Read old build.yaml versions
        id: old_versions
        run: |
          ADDIR='minecraftserver'
          BDS_OLD=$(yq -r '.args.BDS_VERSION' "$ADDIR/build.yaml")
          EASY_ADD_OLD=$(yq -r '.args.EASY_ADD_VERSION' "$ADDIR/build.yaml")
          ENTRYPOINT_DEMOTER_OLD=$(yq -r '.args.ENTRYPOINT_DEMOTER_VERSION' "$ADDIR/build.yaml")
          SET_PROPERTY_OLD=$(yq -r '.args.SET_PROPERTY_VERSION' "$ADDIR/build.yaml")
          RESTIFY_OLD=$(yq -r '.args.RESTIFY_VERSION' "$ADDIR/build.yaml")
          MC_MONITOR_OLD=$(yq -r '.args.MC_MONITOR_VERSION' "$ADDIR/build.yaml")

          echo "bds_old=$BDS_OLD" >> "$GITHUB_OUTPUT"
          echo "easy_add_old=$EASY_ADD_OLD" >> "$GITHUB_OUTPUT"
          echo "entrypoint_demoter_old=$ENTRYPOINT_DEMOTER_OLD" >> "$GITHUB_OUTPUT"
          echo "set_property_old=$SET_PROPERTY_OLD" >> "$GITHUB_OUTPUT"
          echo "restify_old=$RESTIFY_OLD" >> "$GITHUB_OUTPUT"
          echo "mc_monitor_old=$MC_MONITOR_OLD" >> "$GITHUB_OUTPUT"

      # =====================
      # Step 1: Bedrock Server
      # =====================
      - name: Query Mojang API (Bedrock)
        id: upstream
        run: |
          API="https://net-secondary.web.minecraft-services.net/api/v1.0/download/links"
          LATEST_URL="$(curl -s "$API" | jq -r '.result.links[] | select(.downloadType=="serverBedrockLinux") | .downloadUrl')"
          test -n "$LATEST_URL" && [ "$LATEST_URL" != "null" ] || { echo "No Linux URL found"; exit 1; }
          echo "latest_url=$LATEST_URL" >> "$GITHUB_OUTPUT"
          if [[ "$LATEST_URL" =~ bedrock-server-([0-9.]+)\.zip ]]; then
            echo "latest_bds_version=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
          else
            echo "Could not parse version from: $LATEST_URL"; exit 1
          fi

      # =====================
      # Step 2: Update build.yaml met nieuwste add-on versies
      # =====================
      - name: Check for add-on updates
        id: check_addons
        run: |
          ADDIR='minecraftserver'
          UPDATED=false
          CHANGELOG_ENTRIES=""

          # EASY_ADD
          LATEST_EASY_ADD=$(curl -s https://api.github.com/repos/itzg/easy-add/releases/latest | jq -r '.tag_name | ltrimstr("v")')
          if [ "$LATEST_EASY_ADD" != "$(yq -r '.args.EASY_ADD_VERSION' "$ADDIR/build.yaml")" ]; then
            yq -i ".args.EASY_ADD_VERSION = \"$LATEST_EASY_ADD\"" "$ADDIR/build.yaml"
            UPDATED=true
            CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}- Updated EASY_ADD from \`$(yq -r '.args.EASY_ADD_VERSION' "$ADDIR/build.yaml")\` to \`$LATEST_EASY_ADD\`\n"
          fi

          # ENTRYPOINT_DEMOTER
          LATEST_ENTRYPOINT=$(curl -s https://api.github.com/repos/itzg/entrypoint-demoter/releases/latest | jq -r '.tag_name | ltrimstr("v")')
          if [ "$LATEST_ENTRYPOINT" != "$(yq -r '.args.ENTRYPOINT_DEMOTER_VERSION' "$ADDIR/build.yaml")" ]; then
            yq -i ".args.ENTRYPOINT_DEMOTER_VERSION = \"$LATEST_ENTRYPOINT\"" "$ADDIR/build.yaml"
            UPDATED=true
            CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}- Updated Entrypoint Demoter from \`$(yq -r '.args.ENTRYPOINT_DEMOTER_VERSION' "$ADDIR/build.yaml")\` to \`$LATEST_ENTRYPOINT\`\n"
          fi

          # SET_PROPERTY
          LATEST_SET_PROPERTY=$(curl -s https://api.github.com/repos/itzg/set-property/releases/latest | jq -r '.tag_name | ltrimstr("v")')
          if [ "$LATEST_SET_PROPERTY" != "$(yq -r '.args.SET_PROPERTY_VERSION' "$ADDIR/build.yaml")" ]; then
            yq -i ".args.SET_PROPERTY_VERSION = \"$LATEST_SET_PROPERTY\"" "$ADDIR/build.yaml"
            UPDATED=true
            CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}- Updated Set Property from \`$(yq -r '.args.SET_PROPERTY_VERSION' "$ADDIR/build.yaml")\` to \`$LATEST_SET_PROPERTY\`\n"
          fi

          # RESTIFY
          LATEST_RESTIFY=$(curl -s https://api.github.com/repos/itzg/restify/releases/latest | jq -r '.tag_name | ltrimstr("v")')
          if [ "$LATEST_RESTIFY" != "$(yq -r '.args.RESTIFY_VERSION' "$ADDIR/build.yaml")" ]; then
            yq -i ".args.RESTIFY_VERSION = \"$LATEST_RESTIFY\"" "$ADDIR/build.yaml"
            UPDATED=true
            CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}- Updated Restify from \`$(yq -r '.args.RESTIFY_VERSION' "$ADDIR/build.yaml")\` to \`$LATEST_RESTIFY\`\n"
          fi

          # MC_MONITOR
          LATEST_MC_MONITOR=$(curl -s https://api.github.com/repos/itzg/mc-monitor/releases/latest | jq -r '.tag_name | ltrimstr("v")')
          if [ "$LATEST_MC_MONITOR" != "$(yq -r '.args.MC_MONITOR_VERSION' "$ADDIR/build.yaml")" ]; then
            yq -i ".args.MC_MONITOR_VERSION = \"$LATEST_MC_MONITOR\"" "$ADDIR/build.yaml"
            UPDATED=true
            CHANGELOG_ENTRIES="${CHANGELOG_ENTRIES}- Updated MC Monitor from \`$(yq -r '.args.MC_MONITOR_VERSION' "$ADDIR/build.yaml")\` to \`$LATEST_MC_MONITOR\`\n"
          fi

          echo "addons_updated=$UPDATED" >> "$GITHUB_OUTPUT"
          echo -e "addons_changelog=$CHANGELOG_ENTRIES" >> "$GITHUB_OUTPUT"

      # =====================
      # Step 3: Update build.yaml met nieuwste Bedrock URL en versie (indien nodig)
      # =====================
      - name: Update Bedrock URL and version if needed
        id: update_bds
        run: |
          ADDIR='minecraftserver'
          CURRENT_BDS_URL=$(yq -r '.args.BDS_URL' "$ADDIR/build.yaml")
          CURRENT_BDS_VERSION=$(yq -r '.args.BDS_VERSION' "$ADDIR/build.yaml")
          LATEST_BDS_URL="${{ steps.upstream.outputs.latest_url }}"
          LATEST_BDS_VERSION="${{ steps.upstream.outputs.latest_bds_version }}"

          if [ "$CURRENT_BDS_URL" != "$LATEST_BDS_URL" ]; then
            yq -i ".args.BDS_URL = \"$LATEST_BDS_URL\"" "$ADDIR/build.yaml"
            yq -i ".args.BDS_VERSION = \"$LATEST_BDS_VERSION\"" "$ADDIR/build.yaml"
            echo "bds_updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "bds_updated=false" >> "$GITHUB_OUTPUT"
          fi

      # Stap 4: Lees nieuwe versies na updates uit build.yaml
      - name: Read new build.yaml versions
        id: new_versions
        run: |
          ADDIR='minecraftserver'
          BDS_NEW=$(yq -r '.args.BDS_VERSION' "$ADDIR/build.yaml")
          EASY_ADD_NEW=$(yq -r '.args.EASY_ADD_VERSION' "$ADDIR/build.yaml")
          ENTRYPOINT_DEMOTER_NEW=$(yq -r '.args.ENTRYPOINT_DEMOTER_VERSION' "$ADDIR/build.yaml")
          SET_PROPERTY_NEW=$(yq -r '.args.SET_PROPERTY_VERSION' "$ADDIR/build.yaml")
          RESTIFY_NEW=$(yq -r '.args.RESTIFY_VERSION' "$ADDIR/build.yaml")
          MC_MONITOR_NEW=$(yq -r '.args.MC_MONITOR_VERSION' "$ADDIR/build.yaml")

          echo "bds_new=$BDS_NEW" >> "$GITHUB_OUTPUT"
          echo "easy_add_new=$EASY_ADD_NEW" >> "$GITHUB_OUTPUT"
          echo "entrypoint_demoter_new=$ENTRYPOINT_DEMOTER_NEW" >> "$GITHUB_OUTPUT"
          echo "set_property_new=$SET_PROPERTY_NEW" >> "$GITHUB_OUTPUT"
          echo "restify_new=$RESTIFY_NEW" >> "$GITHUB_OUTPUT"
          echo "mc_monitor_new=$MC_MONITOR_NEW" >> "$GITHUB_OUTPUT"

      # Stap 5: Vergelijk oud en nieuw en beslis update_needed
      - name: Decide if any update is needed
        id: decide_any
        run: |
          UPDATE_NEEDED=false

          if [ "${{ steps.old_versions.outputs.bds_old }}" != "${{ steps.new_versions.outputs.bds_new }}" ]; then
            UPDATE_NEEDED=true
          fi
          if [ "${{ steps.old_versions.outputs.easy_add_old }}" != "${{ steps.new_versions.outputs.easy_add_new }}" ]; then
            UPDATE_NEEDED=true
          fi
          if [ "${{ steps.old_versions.outputs.entrypoint_demoter_old }}" != "${{ steps.new_versions.outputs.entrypoint_demoter_new }}" ]; then
            UPDATE_NEEDED=true
          fi
          if [ "${{ steps.old_versions.outputs.set_property_old }}" != "${{ steps.new_versions.outputs.set_property_new }}" ]; then
            UPDATE_NEEDED=true
          fi
          if [ "${{ steps.old_versions.outputs.restify_old }}" != "${{ steps.new_versions.outputs.restify_new }}" ]; then
            UPDATE_NEEDED=true
          fi
          if [ "${{ steps.old_versions.outputs.mc_monitor_old }}" != "${{ steps.new_versions.outputs.mc_monitor_new }}" ]; then
            UPDATE_NEEDED=true
          fi

          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_OUTPUT"

      # Stap 6: Bump addon version if needed
      - name: Update addon version (patch bump)
        if: steps.decide_any.outputs.update_needed == 'true'
        id: bump
        run: |
          set -e
          ADDIR='minecraftserver'
          CUR_ADDON_VER=$(yq -r '.version' "$ADDIR/config.yaml")
          IFS='.' read -r MAJ MIN PAT <<< "$CUR_ADDON_VER"
          PAT=$((PAT+1))
          NEW_ADDON_VER="${MAJ}.${MIN}.${PAT}"
          yq -i ".version = \"${NEW_ADDON_VER}\"" "$ADDIR/config.yaml"
          echo "new_addon_version=$NEW_ADDON_VER" >> "$GITHUB_OUTPUT"

      # =====================
      # Step 7: Update CHANGELOG
      # =====================
      - name: Update CHANGELOG
        if: steps.decide_any.outputs.update_needed == 'true'
        run: |
          set -e
          ADDIR='minecraftserver'
          VER='${{ steps.bump.outputs.new_addon_version }}'
          NOW="$(TZ=Europe/Amsterdam date +%Y-%m-%d)"
          CHANGELOG_PATH="$ADDIR/CHANGELOG.md"
      
          # =====================
          # Bedrock entry (alleen bij update)
          # =====================
          CUR_BDS='${{ steps.current.outputs.cur_bds_version }}'
          LATEST_BDS='${{ steps.upstream.outputs.latest_bds_version }}'
          BEDROCK_ENTRY=""
          if [ "$CUR_BDS" != "$LATEST_BDS" ]; then
            BEDROCK_ENTRY="- Updated Bedrock Server from \`$CUR_BDS\` to \`$LATEST_BDS\`"
          fi
      
          # =====================
          # Add-ons changelog entries
          # =====================
          ADDONS_CHANGES=""
          for addon in EASY_ADD ENTRYPOINT_DEMOTER SET_PROPERTY RESTIFY MC_MONITOR; do
            CUR_VER_VAR="steps.current.outputs.${addon,,}"
            LATEST_VER_VAR="steps.check_addons.outputs.${addon}_latest"
            CUR_VER="${{ steps.current.outputs[addon,,] }}"
            LATEST_VER="${{ steps.check_addons.outputs[addon]_latest }}"
            if [ "$CUR_VER" != "$LATEST_VER" ]; then
              ADDONS_CHANGES="${ADDONS_CHANGES}- Updated $addon from \`$CUR_VER\` to \`$LATEST_VER\`\n"
            fi
          done
      
          # =====================
          # Schrijf changelog
          # =====================
          {
            echo "## ${VER} - ${NOW}"
            [ -n "$BEDROCK_ENTRY" ] && echo "$BEDROCK_ENTRY"
            [ -n "$ADDONS_CHANGES" ] && echo -e "$ADDONS_CHANGES"
            echo
            if [ -f "$CHANGELOG_PATH" ]; then cat "$CHANGELOG_PATH"; else echo "# Changelog"; fi
          } > "${CHANGELOG_PATH}.new"
      
          mv "${CHANGELOG_PATH}.new" "$CHANGELOG_PATH"

      # Stap 8: Commit & Push changes
      - name: Commit changes
        if: steps.decide_any.outputs.update_needed == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add minecraftserver/build.yaml minecraftserver/config.yaml minecraftserver/CHANGELOG.md
          git commit -m "chore(minecraftserver): release ${{ steps.bump.outputs.new_addon_version }}"
          git push

      # Stap 9: Tag
      - name: Create tag
        if: steps.decide_any.outputs.update_needed == 'true'
        run: |
          set -e
          TAG="minecraftserver-v${{ steps.bump.outputs.new_addon_version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      # Stap 10: GitHub Release
      - name: Create GitHub Release
        if: steps.decide_any.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: minecraftserver-v${{ steps.bump.outputs.new_addon_version }}
          name: minecraftserver v${{ steps.bump.outputs.new_addon_version }}
          generate_release_notes: true
          body: |
            Bedrock Server updated to ${{ steps.new_versions.outputs.bds_new }}.
            Add-on version: ${{ steps.bump.outputs.new_addon_version }}.
            See changelog in minecraftserver/CHANGELOG.md
